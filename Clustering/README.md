We first derived compartments, high-level clusters, encompassing major cell types. Then, we performed iterative clustering to identify cell types. We used the first 15 PCs corrected by Harmony to compute the nearest neighbor graph. Then we identified the compartments using the Leiden algorithm implemented in the FindClusters function in Seurat. For each compartment, we subsetted the nuclei, selected highly variable genes, computed the first 15 PCs, corrected the PCs for batch effects using Harmony, computed the nearest neighbor graph with the Harmony embedding, and clustered the nuclei using the FindClusters function in Seurat. 
