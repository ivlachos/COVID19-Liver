# NanoString GeoMx DSP data preprocessing 

Sequencing reads were compiled into FASTQ files corresponding to each region of interest (ROI) using bcl2fastq. FASTQ files were demultiplexed and converted to Digital Count Conversion (DCC) files with NanoString’s GeoMx NGS DnD Pipeline. The resulting DCC files were converted to an expression count matrix. Raw probe data for 18,372 endogenous genes, with 18,346 genes having one probe per gene and 26 SARS-CoV-2 related genes having 5 probes per gene, as well as 105 global negative probes and 8 SARS-CoV-2 negative probes were generated for 71 ROIs, spanning the portal region, all 3 lobular zones and CD45 regions from 4 patients. The probe counts were normalized using the TMM normalization method implemented in edgeR v.3.28.1. In order to account for unwanted variation, we estimated surrogate variables (SVs) using Iteratively Adaptive Surrogate Variable Analysis (IA-SVA) [117] specifying the model “~ Region + Donor”. The expression values were subsequently adjusted with limma’s removeBatchEffect function with Donor as batch and the SVs as covariates. 

# NanoString GeoMx DSP pathway activity scores

As in the case of pathway activity scores for snRNAseq data, a similar approach was utilized for GeoMx DSP datasets. First, ranks were established based on the raw probe counts for each ROI. Then, the ranks were centered and scaled (per ROI). The pathway score was calculated as the sum of the scaled and centered ranks of the genes in the pathway annotation scaled by the square root of the number of genes in the pathway. Unwanted technical variation was accounted for in the pathways scores by estimating surrogate variables (SVs) using the IA-SVA method with the model “~ Region + Donor + log(Nuclei Counts) + log(ROI size)”. Then, the pathway scores were adjusted with limma’s removeBatchEffect function with Donor as batch, the SVs, log(Nuclei Counts), and log(ROI size) as covariates. 

# NanoString GeoMx DSP viral scores

A SARS-CoV-2 viral score was calculated for the GeoMx DSP WTA ROIs using the extended SARS-COV-2 probe set. In particular, the probes for the S and ORF1ab SARS-CoV-2 genes were utilized. First, the ranks per ROI were calculated based on the raw counts for both the target and negative probes in the SARS-COV-2 probe set, and subsequently centered and scaled. Following a similar approach to the pathway activity scores, the viral score was calculated as the sum of the scaled and centered ranks for the S and ORF1ab probes multiplied by the square root of 2 (the number of genes in the set). Then, the negative and target probe labels were permuted 10,000 times and the viral score was calculated for each permutation to estimate the mean and standard deviation of the viral score. Using these estimates, the observed viral score in each ROI was centered and scaled. Limma’s removeBatchEffect function with the model “log(Nuclei counts) + log(ROI size)” as covariates was utilized to account for ROI size and nuclei counts within the ROI. Finally, the adjusted viral scores were fit to the linear model “~ 0 + Donor” using limma to compare the viral scores between donors. For each donor, a contrast was fit to compare the mean adjusted viral score with the mean of the other donors. For example, the contrast for donor L1 is “Donor L1 - (Donor L2 + Donor L3 + Donor L4)/3”.

# NanoString GeoMx DSP differential expression analysis

Limma-trend was utilized to perform differential expression analysis with the GeoMx DSP data. First, batch-corrected expression was fit into the model “~ Region” with the limma-trend method and a robust empirical Bayes procedure. Contrasts were utilized to compare the mean of a region against all others, with a gene considered as a region-specific marker if the contrast was significant at an FDR of 0.05 and the region coefficient higher than all other regions. Limma was also used to fit the same model “~ Region” on the pathway scores but without the mean-variance trend since the pathway scores are approximately normally distributed. The criteria to select pathway markers were the same as for genes.
For the rotation/scale normalized zonation gradient, ROIs were grouped by lobule and the distance to the zone 1 ROI was calculated per ROI, per lobule. Distances were normalized to be in the [0,1] range. Using the normalized distances, the model “~ Normalized Distance” was fit with the batch corrected values, the limma-trend method, and a robust empirical Bayes procedure. We used the coefficient for the normalized distance to identify genes that have an increasing and decreasing pattern across the zonation gradient. For the pathway scores, the same model was fit without the mean-variance trend.
